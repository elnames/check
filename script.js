// Variables globales
let currentScreen = 'welcome';
let currentQuestionIndex = 0;

// Preguntas rom√°nticas sobre su historia
const questions = [
    {
        title: "Para continuar, necesito que recuerdes...",
        hint: "¬øCu√°l fue el primer lugar donde fuimos a comer juntos? ü§î",
        answers: ['tio tomate', 'tiotomate', 'Tio tomate', 'Tiotomate', 'gabimusic', 'Gabimusic', 'GABIMUSIC', 'T√≠o tomate', 't√≠o tomate', 'T√≠otomate']
    },
    {
        title: "Sigamos recordando momentos especiales...",
        hint: "¬øD√≥nde nos conocimos por primera vez? üíï",
        answers: ['la blondie', 'blondie', 'La blondie', 'Blondie', 'la blondie santiago', 'blondie santiago']
    },
    {
        title: "Recordemos un momento gracioso...",
        hint: "¬øA qu√© evento fuimos que fue un fracaso por culpa de Leo Fome Force? üòÖ",
        answers: ['zapravka', 'Zapravka', 'ZAPRAVKA', 'techno ruso', 'los wnes de zapravka']
    },
    {
        title: "Pero despu√©s tuvimos un momento genial...",
        hint: "¬øA qu√© evento fuimos despu√©s y la pasamos s√∫per bien? üéâ",
        answers: ['superklub', 'Superklub', 'SUPERKLUB', 'super klub', 'Super Klub', 'HSU SuperKlub', 'hsu superklub', 'HSU', 'hsu']
    },
    {
        title: "√öltima pregunta para llegar a la sorpresa...",
        hint: "¬øA qu√© pa√≠s so√±amos con ir juntos? üåç‚úàÔ∏è",
        answers: ['espa√±a', 'Espa√±a', 'ESPA√ëA', 'espana', 'Espana']
    }
];

// Variables para elementos del DOM
let screens = {};
let elements = {};

// Funci√≥n para inicializar elementos del DOM
function initializeElements() {
    screens = {
        welcome: document.getElementById('welcome-screen'),
        questions: document.getElementById('questions-screen'),
        reveal: document.getElementById('reveal-screen'),
        specialVideos: document.getElementById('special-videos-screen'),
        confirmation: document.getElementById('confirmation-screen'),
        tickets: document.getElementById('tickets-screen')
    };

    elements = {
        startBtn: document.getElementById('start-btn'),
        questionInput: document.getElementById('question-input'),
        questionSubmitBtn: document.getElementById('question-submit-btn'),
        showTicketsBtn: document.getElementById('show-tickets-btn'),
        showConfirmationBtn: document.getElementById('show-confirmation-btn'),
        yesBtn: document.getElementById('yes-btn'),
        restartBtn: document.getElementById('restart-btn'),
        questionErrorMessage: document.getElementById('question-error-message'),
        questionSuccessMessage: document.getElementById('question-success-message'),
        questionTitle: document.getElementById('question-title'),
        questionHint: document.getElementById('question-hint'),
        progressText: document.getElementById('progress-text'),
        progressFill: document.getElementById('progress-fill')
    };
    
    console.log('Elementos inicializados:', elements);
}

// Funciones de navegaci√≥n
function showScreen(screenName) {
    console.log('Intentando mostrar pantalla:', screenName);

    // Ocultar todas las pantallas
    Object.values(screens).forEach(screen => {
        if (screen) {
            screen.classList.remove('active');
        }
    });

    // Mostrar la pantalla solicitada
    if (screens[screenName]) {
        screens[screenName].classList.add('active');
        currentScreen = screenName;
        console.log('Pantalla mostrada:', screenName);

        // Efectos especiales seg√∫n la pantalla
        if (screenName === 'questions') {
            loadCurrentQuestion();
        } else if (screenName === 'reveal') {
            createConfetti();
        } else if (screenName === 'tickets') {
            createConfetti();
        }
    } else {
        console.error('Pantalla no encontrada:', screenName);
    }
}

// Funci√≥n para cargar la pregunta actual
function loadCurrentQuestion() {
    if (currentQuestionIndex < questions.length) {
        const question = questions[currentQuestionIndex];
        
        if (elements.questionTitle) elements.questionTitle.textContent = question.title;
        if (elements.questionHint) elements.questionHint.textContent = question.hint;
        if (elements.progressText) elements.progressText.textContent = `Pregunta ${currentQuestionIndex + 1} de ${questions.length}`;
        if (elements.progressFill) elements.progressFill.style.width = `${((currentQuestionIndex + 1) / questions.length) * 100}%`;
        
        // Limpiar mensajes anteriores
        if (elements.questionErrorMessage) elements.questionErrorMessage.textContent = '';
        if (elements.questionSuccessMessage) elements.questionSuccessMessage.textContent = '';
        if (elements.questionInput) elements.questionInput.value = '';
    }
}

// Utilidad para normalizar texto (min√∫sculas, sin acentos ni s√≠mbolos)
function normalizeText(text) {
    return text
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]/g, '');
}

// Funci√≥n para validar respuestas
function validateAnswer() {
    const rawAnswer = elements.questionInput.value.trim();
    const userAnswer = rawAnswer.toLowerCase();
    const normalizedAnswer = normalizeText(rawAnswer);
    const currentQuestion = questions[currentQuestionIndex];

    // Atajo: si en la primera pregunta escriben "gabimusic" (en cualquier variante), ir directo a entradas
    if (currentQuestionIndex === 0 && normalizedAnswer === 'gabimusic') {
        showScreen('tickets');
        return;
    }
    
    if (currentQuestion.answers.includes(userAnswer)) {
        // Respuesta correcta
        if (elements.questionSuccessMessage) {
            elements.questionSuccessMessage.textContent = '¬°Correcto! üíï';
        }
        
        currentQuestionIndex++;
        
        if (currentQuestionIndex < questions.length) {
            // Siguiente pregunta
            setTimeout(() => {
                loadCurrentQuestion();
            }, 1500);
        } else {
            // Todas las preguntas respondidas
            setTimeout(() => {
                showScreen('reveal');
            }, 1500);
        }
    } else {
        // Respuesta incorrecta
        if (elements.questionErrorMessage) {
            elements.questionErrorMessage.textContent = 'Int√©ntalo de nuevo... üíî';
        }
        
        // Limpiar mensaje de error despu√©s de 2 segundos
        setTimeout(() => {
            if (elements.questionErrorMessage) {
                elements.questionErrorMessage.textContent = '';
            }
        }, 2000);
    }
}

// Funci√≥n para crear efectos de confeti
function createConfetti() {
    const confettiContainer = document.createElement('div');
    confettiContainer.style.position = 'fixed';
    confettiContainer.style.top = '0';
    confettiContainer.style.left = '0';
    confettiContainer.style.width = '100%';
    confettiContainer.style.height = '100%';
    confettiContainer.style.pointerEvents = 'none';
    confettiContainer.style.zIndex = '9999';
    
    document.body.appendChild(confettiContainer);
    
    for (let i = 0; i < 50; i++) {
        const confetti = document.createElement('div');
        confetti.style.position = 'absolute';
        confetti.style.width = '10px';
        confetti.style.height = '10px';
        confetti.style.backgroundColor = ['#ff69b4', '#ff1493', '#ffc0cb', '#ffb6c1'][Math.floor(Math.random() * 4)];
        confetti.style.left = Math.random() * 100 + '%';
        confetti.style.top = '-10px';
        confetti.style.borderRadius = '50%';
        confetti.style.animation = `fall ${2 + Math.random() * 3}s linear forwards`;
        
        confettiContainer.appendChild(confetti);
    }
    
    // Remover confeti despu√©s de la animaci√≥n
    setTimeout(() => {
        if (confettiContainer.parentNode) {
            confettiContainer.parentNode.removeChild(confettiContainer);
        }
    }, 5000);
}

// Funci√≥n para abrir modal de im√°genes/videos
function openModal(src, caption, type) {
    const modal = document.getElementById('imageModal');
    const modalImage = document.getElementById('modalImage');
    const modalVideo = document.getElementById('modalVideo');
    const modalCaption = document.getElementById('modalCaption');

    console.log('Abriendo modal:', { src, caption, type });

    modal.style.display = 'block';
    modalCaption.textContent = caption;

    if (type === 'video') {
        modalImage.style.display = 'none';
        modalVideo.style.display = 'block';
        modalVideo.src = encodeURI(src);
        modalVideo.setAttribute('playsinline', '');
        modalVideo.setAttribute('webkit-playsinline', '');
        modalVideo.setAttribute('preload', 'metadata');
        modalVideo.muted = false;
        
        modalVideo.load();
        modalVideo.play().catch(error => {
            console.warn('Video autoplay prevented:', error);
        });
    } else {
        modalVideo.style.display = 'none';
        modalImage.style.display = 'block';
        modalImage.src = src;
    }

    console.log('Caption establecida:', modalCaption.textContent);
}

// Funci√≥n para cerrar modal
function closeModal() {
    const modal = document.getElementById('imageModal');
    const modalVideo = document.getElementById('modalVideo');

    modal.style.display = 'none';
    modalVideo.pause();
    modalVideo.currentTime = 0;
    modalVideo.removeAttribute('src');
    modalVideo.load();
}

// Funci√≥n para descargar PDF
function downloadPDF(pdfPath) {
    const link = document.createElement('a');
    link.href = pdfPath;
    link.download = pdfPath.split('/').pop();
    link.click();
}

// Funci√≥n para mostrar QR
function showQR(qrPath, qrTitle) {
    openModal(qrPath, qrTitle, 'image');
}

// CSS para animaci√≥n de confeti
const style = document.createElement('style');
style.textContent = `
    @keyframes fall {
        to {
            transform: translateY(100vh) rotate(360deg);
        }
    }
`;
document.head.appendChild(style);

// Event Listeners
document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM cargado, inicializando...');
    
    // Inicializar elementos
    initializeElements();
    
    console.log('Bot√≥n start:', elements.startBtn);
    
    // Bot√≥n de inicio
    if (elements.startBtn) {
        elements.startBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Bot√≥n empezar clickeado!');
            showScreen('questions');
        });
        console.log('Event listener del bot√≥n empezar configurado');
    } else {
        console.error('No se encontr√≥ el bot√≥n start-btn');
    }

    // Bot√≥n de env√≠o de respuesta
    if (elements.questionSubmitBtn) {
        elements.questionSubmitBtn.addEventListener('click', validateAnswer);
    }

    // Input de respuesta
    if (elements.questionInput) {
        elements.questionInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                validateAnswer();
            }
        });
    }

    // Bot√≥n para mostrar tickets
    if (elements.showTicketsBtn) {
        elements.showTicketsBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Mostrando videos especiales...');
            showScreen('specialVideos');
        });
    }

    // Bot√≥n para mostrar confirmaci√≥n
    if (elements.showConfirmationBtn) {
        elements.showConfirmationBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Mostrando confirmaci√≥n...');
            showScreen('confirmation');
        });
    }

    // Bot√≥n de confirmaci√≥n
    if (elements.yesBtn) {
        elements.yesBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('Confirmaci√≥n aceptada!');
            showScreen('tickets');
        });
    }

    // Bot√≥n de reinicio
    if (elements.restartBtn) {
        elements.restartBtn.addEventListener('click', () => {
            currentQuestionIndex = 0;
            showScreen('welcome');
            if (elements.questionInput) elements.questionInput.value = '';
        });
    }

    // Modal event listeners
    const modal = document.getElementById('imageModal');
    const closeBtn = document.querySelector('.close');
    
    if (closeBtn) {
        closeBtn.addEventListener('click', closeModal);
    }
    
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeModal();
            }
        });
    }
    
    console.log('Todos los event listeners configurados');
});
